---
# Playbook: install Docker, Prometheus, and Grafana
- hosts: aws
  become: yes

  vars:
    prometheus_image: prom/prometheus:latest
    grafana_image: grafana/grafana:latest
    prometheus_container_name: prometheus
    grafana_container_name: grafana
    prometheus_config_src: files/prometheus.yml
    prometheus_config_dest: /opt/prometheus

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install required system packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - software-properties-common
          - python3
          - python3-pip
        state: present

    - name: Install Python docker SDK via pip3
      pip:
        name: docker
        executable: pip3
        state: present

    - name: Install Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable
        state: present

    - name: Install Docker
      apt:
        name: docker-ce
        state: present
        update_cache: yes

    - name: Ensure Docker service running
      service:
        name: docker
        state: started
        enabled: yes

    - name: Create Prometheus config directory
      file:
        path: "{{ prometheus_config_dest }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Copy Prometheus config file
      copy:
        src: "{{ prometheus_config_src }}"
        dest: "{{ prometheus_config_dest }}/prometheus.yml"
        owner: root
        group: root
        mode: "0644"

    - name: Run Prometheus container
      community.docker.docker_container:
        name: "{{ prometheus_container_name }}"
        image: "{{ prometheus_image }}"
        state: started
        restart_policy: always
        pull: yes
        ports:
          - "9090:9090"
        volumes:
          - "{{ prometheus_config_dest }}/prometheus.yml:/etc/prometheus/prometheus.yml:ro"

    - name: Run Grafana container
      community.docker.docker_container:
        name: "{{ grafana_container_name }}"
        image: "{{ grafana_image }}"
        state: started
        restart_policy: always
        pull: yes
        ports:
          - "3000:3000"
